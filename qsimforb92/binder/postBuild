#!/bin/bash

# Binder post-build script for Quantum Networking System
echo "ğŸ”§ Setting up Quantum Networking System for Binder..."

# Check if Node.js is available (Binder usually has it pre-installed)
if command -v node >/dev/null 2>&1; then
    echo "âœ… Node.js is already available"
    echo "Node.js version: $(node --version)"
    echo "npm version: $(npm --version)"
else
    echo "âš ï¸ Node.js not found, but continuing with Python setup..."
fi

# Create necessary directories
mkdir -p saved_topologies
mkdir -p simulation_logs
mkdir -p ui/dist

# Install Python requirements
echo "ğŸ“¦ Installing Python requirements..."
pip install --no-cache-dir -r binder_requirements.txt

# Navigate to UI directory and install React dependencies
echo "ğŸ“¦ Installing React dependencies..."
cd ui

# Install npm dependencies
npm install --production=false

# Build the React application
echo "ğŸ—ï¸ Building React application..."
npm run build

# Verify build
if [ -d "dist" ]; then
    echo "âœ… React build successful!"
    ls -la dist/
else
    echo "âš ï¸ React build failed, but continuing..."
fi

# Go back to root
cd ..

# Set up Jupyter extensions (with error handling)
echo "ğŸ“š Setting up Jupyter extensions..."
# Try to install contrib nbextensions, but don't fail if it doesn't work
if jupyter contrib nbextension install --sys-prefix 2>/dev/null; then
    echo "âœ… Jupyter contrib nbextensions installed"
else
    echo "âš ï¸ Jupyter contrib nbextensions not available, skipping..."
fi

# Enable widget extension (essential for ipywidgets)
if jupyter nbextension enable --py widgetsnbextension --sys-prefix 2>/dev/null; then
    echo "âœ… Widget extension enabled"
else
    echo "âš ï¸ Widget extension not available, continuing..."
fi

# Create a simple startup script
cat > start_binder.sh << 'EOF'
#!/bin/bash
echo "ğŸš€ Starting Quantum Networking System on Binder..."
echo "ğŸ“Š Backend will be available at: /proxy/5174"
echo "ğŸ“š Jupyter notebook will be available at: /lab"
echo "ğŸ”— Opening notebook..."

# Start the FastAPI backend in background
python binder_app.py &
BACKEND_PID=$!

# Give backend time to start
sleep 5

# Open the main notebook
jupyter lab --no-browser --port=8888 --ip=0.0.0.0 --allow-root --NotebookApp.token='' --NotebookApp.password='' &

echo "âœ… System started! Backend PID: $BACKEND_PID"
echo "ğŸŒ Access your application at the Binder URL with /proxy/5174"
EOF

chmod +x start_binder.sh

echo "âœ… Quantum Networking System setup complete!"
echo "ğŸš€ Ready to start the simulation!"
echo "ğŸ’¡ Run './start_binder.sh' to start both backend and notebook"
